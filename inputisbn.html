<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>我が家の本棚</title>
    <link rel="stylesheet" href="css/destyle.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/main.js"></script>
    <script>
        let uploadURL;
        let booksRegistered = [];
        const openbdURL = "https://api.openbd.jp/v1/get?isbn="; // 完成後main.jsに移動

        window.addEventListener("DOMContentLoaded", function () {
            uploadURL = localStorage.getItem("endpoint");
            if (uploadURL === null) {
                alert("アップロードURLが登録されていません。前の画面に戻って登録してください。");
            }
        });

        function deleteRegisteredBook(isbn) {
            const registeredBooksArray = document.getElementById("registeredbooks").children;
            for (let i = 0; i < registeredBooksArray.length; i++) {
                let bookdiv = registeredBooksArray[i];
                if (bookdiv.getElementsByClassName("isbnval")[0].innerText == isbn) {
                    bookdiv.remove();
                    break;
                }
            }
        }

        async function registerISBN() {
            // 同一ISBNの本が登録済みでないか検索
            const isbn = document.getElementById("isbn").value;

            if (isbn === "") {
                alert("ISBNコードが入力されていません。");
                return;
            }

            // TODO: ISBNコードのバリデーション(数字13桁)

            const books = document.getElementById("registeredbooks").children;
            
            for (let i = 0; i < books.length; i++) {
                if (books[i].getElementsByClassName("isbnval")[0].innerText === isbn) {
                    alert("既に登録されています。");
                    return;
                }
            }

            // OpenBDから本の情報を取得
            const bookDataRaw = await getData(openbdURL + isbn);
            const bookData = JSON.parse(bookDataRaw)[0];
            
            if (bookData === null) {
                alert("入力されたISBNコードの本は存在しないか、データベースに登録されていません。");
                return;
            }

            // 要素追加
            const registered = document.getElementById("registeredbooks");

            const bookdiv = registered.appendChild(document.createElement("div"));
            bookdiv.className = "book";

            const bookISBN = bookData.onix.ProductIdentifier.IDValue;
            const bookTitle = bookData.onix.DescriptiveDetail.TitleDetail.TitleElement.TitleText.content;

            let bookAuthorsArray = bookData.onix.DescriptiveDetail.Contributor;
            let bookAuthors = "";
            for (let i = 0; i < bookAuthorsArray.length; i++) {
                bookAuthors += bookAuthorsArray[i].PersonName.content;
                if (i !== bookAuthorsArray.length - 1) {
                    bookAuthors += " / ";
                }
            }

            const isbnkey = bookdiv.appendChild(document.createElement("span"));
            isbnkey.innerText = "ISBN: ";
            isbnkey.className = "bookkey";

            const isbnval = bookdiv.appendChild(document.createElement("span"));
            isbnval.innerText = bookISBN;
            isbnval.className = "isbnval";

            bookdiv.appendChild(document.createElement("br"));

            const titlekey = bookdiv.appendChild(document.createElement("span"));
            titlekey.innerText = "書名: ";
            titlekey.className = "bookkey";

            const titleval = bookdiv.appendChild(document.createElement("span"));
            titleval.innerText = bookTitle;
            titleval.className = "titleval";

            bookdiv.appendChild(document.createElement("br"));

            const authorkey = bookdiv.appendChild(document.createElement("span"));
            authorkey.innerText = "著者: ";
            authorkey.className = "bookkey";

            const authorval = bookdiv.appendChild(document.createElement("span"));
            authorval.innerText = bookAuthors;
            authorval.className = "authorval";

            bookdiv.appendChild(document.createElement("br"));

            const deleteButton = bookdiv.appendChild(document.createElement("button"));
            deleteButton.className = "remove";
            deleteButton.innerText = "削除する";
            deleteButton.addEventListener("click", function() {
                deleteRegisteredBook(bookISBN);
            });
        }
    </script>
</head>

<body>
    <div id="bodyblock">
        <h1>我が家の本棚</h1>
        <div class="inputblock">
            <label for="isbn">ISBNコードを半角で入力してください</label>
            <input type="text" id="isbn">
            <button class="register" id="registerisbn" onclick="registerISBN()">登録する</button>
        </div>
        <h3>登録済み書籍</h3>
        <div id="registeredbooks">
            <!--placeholder-->
            <!-- <div class="book">
                <span class="bookkey">ISBN: </span><span class="isbnval">9764798160054</span><br>
                <span class="bookkey">書名: </span><span class="titleval">図解まるわかり サーバーのしくみ</span><br>
                <span class="bookkey">著者: </span><span class="authorval">西村泰洋</span><br>
                <button class="remove">削除する</button>
            </div> -->
        </div>
    </div>
</body>

</html>
